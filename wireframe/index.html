<!DOCTYPE html>
<html>
  <head>
    <title>Wireframe View</title>

    <link href="https://unpkg.com/@umich-lib/css@v1/dist/umich-lib.css"  rel="stylesheet"/>
    <script type="module"  src="https://unpkg.com/@umich-lib/components@v1/dist/umich-lib/umich-lib.esm.js"></script>
    <script nomodule="" src="https://unpkg.com/@umich-lib/components@v1/dist/umich-lib/umich-lib.js"></script>

    <style>
      #editor {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
      }

      #output {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 100%;
      }

      #controls {
        position: fixed;
        bottom: 1rem;
        right: 1rem;
        background: rgba(0,0,0,0.25);
        /*color: #eee;*/
        padding: 0.5rem;
        z-index: 5000;
        /*border: 2px solid #777;*/
      }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/codemirror.min.js"
      integrity="sha512-UxcTlYsLkcuGZL9JNnMsfo3p7VFSmcgBjH1VUSM82Okk5ni52bk7vz9f2p+D1VnMcNUmMzbzgWqWcdJ2j8Svow=="
      crossorigin="anonymous"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/codemirror.min.css"
      integrity="sha512-xIf9AdJauwKIVtrVRZ0i4nHP61Ogx9fSRAkCLecmE2dL/U8ioWpDvFCAy4dcfecN72HHB9+7FfQj3aiO68aaaw=="
      crossorigin="anonymous" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/addon/fold/xml-fold.min.js"
      integrity="sha512-A687y0hhrzGSJA+Vy0K5wJ+XSIPKjzEujKsc9WCoWfub25q4THmIX94P6ofM5tuUMDuX4SKzjOeliJMbDpyyAQ=="
      crossorigin="anonymous"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/mode/xml/xml.min.js"
      integrity="sha512-k1HnoY9EXahEfPz7kq/lD9DltloKH9OrB9XNKYoUQrNz9epe5F4mQP5PfuIfeRfoXHkNrE0gF3Mx4LhC5BVl9Q=="
      crossorigin="anonymous"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/addon/fold/foldcode.min.js"
      integrity="sha512-tY7fzPt8kpPkGBPzs0ctZAm6+w1vPG/5sm2oPzbuUimqQfVOFJGi8eB7jo8BBEQjwOPuQq4UT04Bbgjuzk//aQ=="
      crossorigin="anonymous"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/addon/fold/foldgutter.min.css"
      integrity="sha512-YwkMTlTHn8dBnwa47IF+cKsS00HPiiVhQ4DpwT1KF2gUftfFR7aefepabSPLAs6zrMyD89M3w0Ow6mQ5XJEUCw=="
      crossorigin="anonymous" />
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/addon/fold/foldgutter.min.js" integrity="sha512-R5ILz8pTG+G29aszTP4k5AbDWbxoaKJ9ilK+hseQVKuuoTNOo95nCbfQYInLhKdsWCKY1sa9Lis2pblTQ0U57A==" crossorigin="anonymous"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/addon/fold/indent-fold.min.js"
      integrity="sha512-Q6g5qQfa6ko+Y+0BwAciUAq01qxgfScTPFP2Fsrr+zIrTe5Yq3tN5xaA919MmBs/1RMz/jyctknYavjc3k+/xg=="
      crossorigin="anonymous"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/addon/fold/xml-fold.min.js"
      integrity="sha512-A687y0hhrzGSJA+Vy0K5wJ+XSIPKjzEujKsc9WCoWfub25q4THmIX94P6ofM5tuUMDuX4SKzjOeliJMbDpyyAQ=="
      crossorigin="anonymous"></script>
      

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/theme/solarized.min.css"
      integrity="sha512-9eh7EKENNB3CJcWthLysOUEcOw1hCVES0IoNcgLeKRgcG1j1HRNXST3b1i7SV/XQEFGAvg7RMm5XbHfdaA0juQ=="
      crossorigin="anonymous" />
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/theme/shadowfox.min.css"
      integrity="sha512-Xt1Gi99yJFMZ0ocjkdHqKWLjtb/l8pzJo5cCmHV2GvBFwJiOCLR2HXQBrcFmqY6i8+gXnRaKTGzoBVOl3YUwjw=="
      crossorigin="anonymous" />

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/theme/rubyblue.min.css"
      integrity="sha512-pt+OhZW7o2pmHEahNFroPWkGR89L0tmDqCzXK+7WM1vGLtUyxms1JxZsXgJbOdFwylRnEt0yHnU6y2uAs40FxQ=="
      crossorigin="anonymous" />

    <script src="./js/xml-formatter.js"></script>

    <link rel="icon"
      href="data:image/svg+xml,&lt;svg xmlns='http://www.w3.org/2000/svg' width='1em' height='1em'>&lt;text y='.9em'>ðŸŽƒ&lt;/text>&lt;/svg>" />


    <style>
      .CodeMirror {
        height: 100%;
        width: 100%;
        font-family: 'Roboto Mono';
        font-size: 18px;
      }

      body[data-mode="output"] #editor {
        display: none;
      }

      body[data-mode="editor"] #output {
        display: none;
      }

    </style>

  </head>
  <body data-mode="output">
    <div id="editor"></div>
    <iframe id="output"></iframe>
    <div id="controls">
      <button id="action-toggle-mode" class="bg-blue-100 text-teal-400 px-4 py-3 rounded cursor-pointer font-bold hover:shadow-outline text-base no-underline">Toggle</button>
    </div>

    <script>
      var inputFilename = '/' + location.search.substr(1);
      document.title += ' : ' + location.search.substr(1);
    </script>
    <script>
      var processor = new XSLTProcessor();

      function loadXMLDoc(filename) {
        var xhttp = new XMLHttpRequest();
        console.log("AHOY", filename);
        xhttp.open("GET", filename, false);
        xhttp.send("");
        return xhttp.responseXML;
      }

      var inputDocument;
      var xsltDocument;
      var resultDocument;
      var preprocessDocument;

      preprocessDocument = loadXMLDoc("../xsl/preprocess_import.xsl");

      var baseName = inputFilename.split('/').pop();
      inputDocument = loadXMLDoc(inputFilename);

      var now = Date.now();
      var transformDocXML = `<?xml version="1.0" encoding="UTF-8" ?>
<xsl:stylesheet version="1.0" xmlns="http://www.w3.org/1999/xhtml" xmlns:xsl="http://www.w3.org/1999/XSL/Transform" xmlns:dlxs="http://dlxs.org" xmlns:qbat="http://dlxs.org/quombat" xmlns:qui="http://dlxs.org/quombat/ui" xmlns:exsl="http://exslt.org/common" extension-element-prefixes="exsl">
  <xsl:import href="/xsl/social.wireframe.xsl?now=${now}" />
  <xsl:import href="/xsl/${baseName.replace('.xml', '.wireframe.xsl')}?_=${now}" />
  <xsl:import href="${inputFilename.replace('.xml', '.wireframe.xsl')}?_=${now}" />
  <xsl:import href="/xsl/wireframe.xsl?_=${now}" />
</xsl:stylesheet>`;

      console.log(transformDocXML);

      var parser = new DOMParser();
      var transformDoc = parser.parseFromString(transformDocXML, "text/xml");

      var _resolve_imports = function(xmldoc) {
        var imports = Array.prototype.slice.call(xmldoc.querySelectorAll('import'));
        while ( imports.length ) {
          var importNode = imports.shift();
          var parentNode = importNode.parentNode;
          var importDocument = loadXMLDoc(importNode.getAttribute('href'));
          var children = importDocument.documentElement.children;
          for(var i = 0; i < children.length; i++) {
            var possibleNode = children[i];
            var expandedNode = xmldoc.importNode(possibleNode, true);

            if ( possibleNode.nodeName == 'xsl:template' && possibleNode.hasAttribute('name') ) {
              // can only be one of these
              var checkNode = xmldoc.querySelector(`template[name="${possibleNode.getAttribute('name')}"]`);
              if ( checkNode ) {
                console.log("REMOVING", checkNode);
                var checkNodeParent = checkNode.parentNode;
                checkNodeParent.removeChild(checkNode);
                // checkNodeParent.replaceChild(expandedNode, checkNode);
              }
            }

            var insertedNode = parentNode.insertBefore(expandedNode, importNode);
            if ( insertedNode.name == 'xsl:import' ) {
              imports.append(insertedNode);
            }

          }
          parentNode.removeChild(importNode);
        }
      }

      _resolve_imports(transformDoc);
      console.log(transformDoc);

      xsltDocument = transformDoc;
      processor.reset();


      try {
        processor.importStylesheet(xsltDocument);
      } catch(err) {
        console.log(err);
      }

      // resultDocument = processor.transformToFragment(inputDocument, document);
      try {
        resultDocument = processor.transformToDocument(inputDocument);
      } catch(err) {
        console.log(err);
      }

      var serializer = new XMLSerializer();
      var formatter = require('xml-formatter');
      var editor;
      var output = document.querySelector('#output');

      var handleEditor = function() {
        document.body.dataset.mode = 'editor';

        var xmldata = formatter(serializer.serializeToString(resultDocument), { collapseContent: true });

        editor = CodeMirror(document.querySelector('#editor'),
          {
            value: xmldata,
            mode: 'text/xml',
            tabSize: 2,
            readOnly: true,
            // theme: 'solarized dark',
            theme: 'shadowfox',
            foldGutter: true,
            lineNumbers: true,
            lineWrapping: false,
            gutters: [ 'CodeMirror-linenumbers', 'CodeMirror-foldgutter']
          }
        );
      }

      var xmldata; var xsldata;
      var handleOutput = function() {
        document.body.dataset.mode = 'output';
        output.style.visibility = 'hidden';

        var ts; var tsIdx = 0;
        ts = setInterval(function() {
          if ( output.contentDocument && output.contentDocument.documentElement.dataset.loaded == 'true' ) {
            clearInterval(ts);
            output.style.visibility = 'visible';
            return;
          }
          tsIdx += 1;
          console.log("-- tick/tock", tsIdx);
        }, 100);

        var serializerDoc = loadXMLDoc("../xsl/wireframe2dsl.xsl");
        console.log(serializerDoc);

        processor.reset();
        processor.importStylesheet(serializerDoc);

        // -- chrome won't transform into a fragment ??
        // var finalDocument = processor.transformToFragment(resultDocument, document);
        var finalDocument = processor.transformToDocument(resultDocument);
        xmldata = serializer.serializeToString(finalDocument);
        console.log(xmldata);

        output.setAttribute('srcdoc', xmldata);
      }

      var handlers = {
        output: handleOutput,
        editor: handleEditor
      };

      var actionToggle = document.querySelector('#action-toggle-mode');
      actionToggle.addEventListener('click', (event) => {
        var target = ( document.body.dataset.mode == 'output' ) ? 'editor' : 'output'
        document.body.dataset.mode = target;
        handlers[target]();
      })

      handleEditor();



    </script>
  </body>
</html>